Again updating the whole code to resolve merge conflict.